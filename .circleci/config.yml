# CircleCI 2.0 configuration
version:  "2.1"

executors:
  linux-amd64:
    machine:
      image: ubuntu-2004:202010-01
      docker_layer_caching: true

commands:
  upgrade_docker:
    steps:
      - run:
          name: Upgrade Docker to the latest available release
          command: |
            export BUILDKIT_PROGRESS=plain
            export DOCKER_BUILDKIT=1
            export DOCKER_CLI_EXPERIMENTAL=enabled
            echo 'export BUILDKIT_PROGRESS=plain' >> $BASH_ENV
            echo 'export DOCKER_BUILDKIT=1' >> $BASH_ENV
            echo 'export DOCKER_CLI_EXPERIMENTAL=enabled' >> $BASH_ENV

            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
            sudo add-apt-repository \
              "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) \
              stable"

            sudo apt-get update
            sudo apt-get install -y \
              containerd.io \
              docker-ce \
              docker-ce-cli
            sudo service docker restart

  deploy_release_packages:
    description:  >
      This will build and publish release packages for tag "$CIRCLE_TAG"
    steps:
      - run:
          name: Deploy Release Packages
          command:  |
            ./build.sh --debug --clean --generate --package --package-udfs --upload --bucket=dl.influxdata.com/kapacitor/releases --platform=all --arch=all --release

  run_tests:
    description:  >
      This will run Kapacitor Tests
    steps:
      - run:
          name: Running Kapacitor Tests
          no_output_timeout: 30m
          command:  |
            ./circle-test.sh
  deploy_nightly:
    description:  >
      This will build and publish nightly releases
    steps:
      - run:
          name: Deploy Nightly Build
          command:  |
            ./build.sh --debug --clean --generate --package --package-udfs --upload --bucket=dl.influxdata.com/kapacitor/releases/nightly --platform=all --arch=all --nightly

jobs:
  build:
    executor: linux-amd64
    parallelism: 2
    working_directory: ~/kapacitor
    steps:
      - checkout
      - upgrade_docker
      - run_tests

  release:
    executor: linux-amd64
    working_directory: ~/kapacitor
    steps:
      - checkout
      - upgrade_docker
      - deploy_release_packages

  nightly-build:
    executor: linux-amd64
    working_directory: ~/kapacitor
    steps:
      - checkout
      - upgrade_docker
      - run_tests
      - deploy_nightly


workflows:
  version:  2
  build-and-deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /.*/
      - release:
          requires:
            - build
          filters:
            tags:
              only:  /^v[0-9]+(\.[0-9]+){2}(-(rc|beta)[0-9]+)?/
            branches:
              ignore:  /.*/

  nightly:
    triggers:
      - schedule:
          cron: "0 3 * * *" #3AM UTC daily
          filters:
            branches:
              only:
                - master
    jobs:
      - nightly-build
